---
title: "p8105_hw5_cw3370.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(purrr)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1

```{r}
homicide_df <- 
  read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv") 
```


```{r}
city_homicide_df <- 
  homicide_df %>% 
  mutate(
    city_state = str_c(city,state,sep = ","),
    disposition = case_when(
      disposition == "Closed without arrest"|disposition =="Open/No arrest" ~"unsolved",
      disposition == "Closed by arrest" ~ "solved"
      ) 
    ) %>% 
   filter(
     city_state != "Tulsa,AL"
   ) %>% 
  relocate(city_state)

prop_homicide <- 
  city_homicide_df %>% 
  group_by(city_state,disposition) %>% 
  summarize(
    homicide = n()
  ) %>% 
  ungroup() %>% 
  pivot_wider(
    names_from = disposition,
    values_from = homicide
  ) %>% 
  mutate(
    total = unsolved + solved
  )

```

```{r}
prop_baltmore <- 
  prop.test(
    x = pull(filter(prop_homicide,city_state == "Baltimore,MD") ,unsolved), 
    n = pull(filter(prop_homicide,city_state == "Baltimore,MD") ,total)
    )  

prop_baltmore %>% 
  broom::tidy()
  
```

```{r eval=FALSE}
prop_test_function <- function(city_df){
  prop_city <- 
    city_df %>% 
    prop.test(
      x = city_df$unsolved,
      n = city_df$solved
      )  
  prop_city <- 
    prop_city %>% 
      broom::tidy()
  
  return(prop_city)
}

prop_homicide <- 
  prop_homicide %>% 
  mutate(
    test_score = map(prop_homicide,prop_test_function)
  )

```


# Problem 2
Start with a dataframe containing all file names; the list.files function will help
```{r}
filename_df <- tibble(
  filenames = list.files("data")
)
```

Iterate over file names and read in data for each subject using purrr::map and saving the result as a new variable in the dataframe
```{r}
read_participant_data <- function(filename){
  filepath <- str_c("data/",filename)
  data = read_csv(filepath)
  return(data)
}

participant_df <- 
  filename_df %>% 
  mutate(
    data = map(filenames,read_participant_data),

    )
```

Tidy the result; manipulate file names to include control arm and subject ID, make sure weekly observations are “tidy”, and do any other tidying that’s necessary
```{r}
participant_df <- 
  participant_df %>% 
  mutate(
    control_arm = substr(filenames,1,3),
    subject_id = substr(filenames,5,6)
    )%>% 
  relocate(subject_id,control_arm) %>% 
  unnest(data) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    names_prefix = "week_",
    values_to = "value"
  ) %>% 
  mutate(
    week=as.numeric(week)
  )
```


```{r}
participant_df %>% 
  ggplot(aes(x = week,y=value,color = subject_id)) +
  geom_point()+
  geom_line()+
  facet_grid(.~control_arm)
```

# Problem 3
```{r}
set.seed(10)
iris_with_missing = iris %>% 
  map_df(~replace(.x, sample(1:150, 20), NA)) %>%
  mutate(Species = as.character(Species))
```

```{r}


replace_value_function <- function(vector){
    if(is.numeric(vector)){
      replace_value = mean(vector,na.rm=TRUE)
    }else if(is.character(vector)){
      replace_value = "virginica"
    }
  replace_na(vector,replace_value)
}

iris_replaced_df <- 
  iris_with_missing %>% 
  map_df(replace_value_function)

```

